# Figure 2. Yellow is produced in the ovary-associated glands and is secreted into the egg caplet, embedding Stammera.

# Figure 2D: Yellow expression across female body compartments + sex comparison
# Figure 2E: Yellow expression in ovary-associated glands across developmental stages

library(dplyr)
library(ggpubr)
library(rstatix)
library(ggplot2)


# Figure 2D. Females: tissue effect

fem <- read.table("old_females.txt", header = TRUE)

# Factors
fem$Condition.f <- factor(fem$Condition)
fem$Tissue.f    <- factor(fem$Tissue)
fem$Replicate.f <- factor(fem$Replicate)

# ordered levels for plotting
fem$Condition.f <- ordered(fem$Condition.f, levels = c("FG_F","SO_F","MG_F","HG_F","OV_F","AG_F"))

# log10 transform for diagnostics only
fem <- fem %>%
  mutate(logRatio_Av_AG = log10(Ratio_Av_AG + 1))

# Normality check
shapiro.test(fem$Ratio_Av_AG)
ggdensity(fem$Ratio_Av_AG,
          main = "Density plot of yellow expression (raw)",
          xlab = "Yellow expression (Ratio_Av_AG)")

# Nonparametric tests 
kw_fem <- kruskal.test(Ratio_Av_AG ~ Tissue.f, data = fem)
print(kw_fem)

# Pairwise Wilcoxon post-hoc with BH correction

pw_fem <- pairwise.wilcox.test(fem$Ratio_Av_AG, fem$Tissue.f, p.adjust.method = "BH")
print(pw_fem)


# Figure 2D. Sex effect (Females vs Males)

sexdat <- read.table("old_females_males.txt", header = TRUE)

sexdat$Condition.f <- factor(sexdat$Condition)
sexdat$Tissue.f    <- factor(sexdat$Tissue)
sexdat$Replicate.f <- factor(sexdat$Replicate)
sexdat$Sex.f       <- factor(sexdat$Sex)


# Normality check

shapiro.test(sexdat$Ratio_Av_AG)
ggdensity(sexdat$Ratio_Av_AG,
          main = "Density plot of yellow expression (raw)",
          xlab = "Yellow expression (Ratio_Av_AG)")

# Non-parametric test

sex_test <- wilcox.test(Ratio_Av_AG ~ Sex.f, data = sexdat)
print(sex_test)


# Set order for plotting

sexdat$Condition.f <- factor(
  sexdat$Condition.f,
  levels = c("FG_M","SO_M","MG_M","HG_M","T_M",
             "FG_F","SO_F","MG_F","HG_F","OV_F","AG_F")
)


# Plotting

p2d_sex <- ggboxplot(
  sexdat,
  x = "Condition.f",
  y = "Ratio_Av_AG",
  fill = "#F7B627",   
  color = "black",   
  ylab = "Yellow gene expression (relative to EF-2)",
  xlab = "Dissected tissues",
  ylim = c(0, 1.25)
) +
  theme(
    panel.border = element_rect(color = "black", fill = NA),
    panel.background = element_blank()
  )

p2d_sex
mod <- lm(Log_1 ~ Treatment.f * Week, data = my_data)
anova(mod)


ggsave("Fig2D_females_males_boxplot.pdf", p2d_sex)
ggsave("Fig2D_females_males_boxplot.svg", p2d_sex)

#Figure 2E.  AG stages (AG_YF vs AG_OF)

ag <- read.table("ag_y_o_final.txt", header = TRUE, row.names = 1)

ag$Condition.f <- factor(ag$Condition)
ag$Replicate.f <- factor(ag$Replicate)

# Set order for plotting

ag$Condition.f <- ordered(ag$Condition.f, levels = c("AG_YF", "AG_OF"))

# Normality check

shapiro.test(ag$Ratio_Av_AG)
ggdensity(ag$Ratio_Av_AG,
          main = "Density plot of yellow expression (raw)",
          xlab = "Yellow expression (Ratio_Av_AG)")


# t-test

t_res <- t.test(Ratio_Av_AG ~ Condition.f, data = ag, var.equal=TRUE)


print(t_res)

# Plotting


p2e <- ggboxplot(
  ag,
  x = "Condition.f",
  y = "Ratio_Av_AG",
  fill = "#F7B627",   
  color = "black",   
  ylab = "Yellow gene expression (relative to EF-2)",
  xlab = "Female developmental stage",
  ylim = c(0, 1.25)
) +
  theme(
    panel.border = element_rect(color = "black", fill = NA),
    panel.background = element_blank()
  )

print(p2e)


ggsave("Fig2E_AG_stages_boxplot.pdf", p2e)
ggsave("Fig2E_AG_stages_boxplot.svg", p2e)
