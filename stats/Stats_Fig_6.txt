# Figure 6. RNA interference effectively reduces yellow expression and depletes the encoded protein in tortoise beetles.

# Figure 6A. Yellow expression levels from week 1 to week 5 post-injection in untreated controls, dsRNA-GFP, and dsRNA-yellow groups.

library(dplyr)
library(ggpubr)
library(multcomp)
library(tibble)



my_data<-read.table("qPCR_yellow_RNAi_copies.txt",header=T)
my_data$Condition.f<-factor(my_data$Condition)
my_data$Replicate.f<-factor(my_data$Replicate)
first_week<-my_data %>%filter(my_data$Week=='1')
second_week<-my_data %>%filter(my_data$Week=='2')
third_week<-my_data %>%filter(my_data$Week=='3')
fifth_week<-my_data %>%filter(my_data$Week=='5')


# First week #

# Model 

lm_model_1_condition_replicate <- lm(Log_1 ~ Condition.f+Replicate.f,data = first_week)

# Normality assumptions

shapiro.test(residuals(lm_model_1_condition_replicate))
leveneTest(Log_1 ~ Condition.f, data = first_week)

qqnorm(residuals(lm_model_1_condition_replicate))
qqline(residuals(lm_model_1_condition_replicate))

# ANOVA

anova(lm_model_1_condition_replicate)

# post hoc

mod_multcomp_lm_model_1_condition_replicate <- glht(lm_model_1_condition_replicate, linfct = mcp(Condition.f = "Tukey"))
summary(mod_multcomp_lm_model_1_condition_replicate,test=adjusted("bonferroni"))


# Second week #

# Model

lm_model_2_condition_replicate <- lm(Log_1 ~ Condition.f+Replicate.f,data = second_week)

# Normality assumptions

shapiro.test(residuals(lm_model_2_condition_replicate))
leveneTest(Log_1 ~ Condition.f, data = second_week)
qqnorm(residuals(lm_model_2_condition_replicate))
qqline(residuals(lm_model_2_condition_replicate))

# ANOVA

anova(lm_model_2_condition_replicate)

# post hoc

mod_multcomp_lm_model_2_condition_replicate <- glht(lm_model_2_condition_replicate, linfct = mcp(Condition.f = "Tukey"))
summary(mod_multcomp_lm_model_2_condition_replicate,test=adjusted("bonferroni"))

# Third week #

# Model

lm_model_3_condition_replicate <- lm(Log_1 ~ Condition.f+Replicate.f,data = third_week)

# Normality assumptions

shapiro.test(residuals(lm_model_3_condition_replicate))
leveneTest(Log_1 ~ Condition.f, data = third_week)
qqnorm(residuals(lm_model_3_condition_replicate))
qqline(residuals(lm_model_3_condition_replicate))


# ANOVA

anova(lm_model_3_condition_replicate)

# post hoc 

mod_multcomp_lm_model_3_condition_replicate <- glht(lm_model_3_condition_replicate, linfct = mcp(Condition.f = "Tukey"))
summary(mod_multcomp_lm_model_3_condition_replicate,test=adjusted("bonferroni"))


# Fifth week #

# Model

lm_model_5_condition_replicate <- lm(Log_1 ~ Condition.f+Replicate.f,data = fifth_week)

# Normality assumptions

shapiro.test(residuals(lm_model_5_condition_replicate))
leveneTest(Log_1 ~ Condition.f, data = fifth_week)
qqnorm(residuals(lm_model_5_condition_replicate))
qqline(residuals(lm_model_5_condition_replicate))

# ANOVA

anova(lm_model_5_condition_replicate)


# post hoc 

mod_multcomp_lm_model_5_condition_replicate <- glht(lm_model_5_condition_replicate, linfct = mcp(Condition.f = "Tukey"))
summary(mod_multcomp_lm_model_5_condition_replicate,test=adjusted("bonferroni"))


# Plotting 

my_data$Condition.f<-ordered(my_data$Condition.f,levels=c("CTL_1W","GFP_1W","YELL_1W","CTL_2W","GFP_2W","YELL_2W","CTL_3W","GFP_3W","YELL_3W","CTL_5W","GFP_5W","YELL_5W"))

p <- ggboxplot(
  my_data,
  x = "Condition.f",
  y = "Expression",
  ylab = "yellow gene expression",
  xlab = "Condition",
  width = 0.5
) +
  scale_y_log10(
    limits = c(0.1, 10000),
    breaks = c(0.1, 1, 10, 100, 1000, 10000)
  ) +
  theme(
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.8),
    panel.background = element_blank(),
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

p


ggsave("Fig6A_qPCR_RNAi_boxplot.pdf", p, width = 10, height = 4)
ggsave("Fig6A_qPCR_RNAi_boxplot.svg", p, width = 10, height = 4)


# NOTE:
# The accepted manuscript analyzes each time point separately (LM per week with Tukey + Bonferroni),
# Below, we also provide an optional global two-way model (Treatment Ã— Week) as a robustness check.


# Create Treatment + Week factors
my_data <- my_data %>%
  mutate(
    Treatment = case_when(
      grepl("^CTL", Condition)  ~ "CTL",
      grepl("^GFP", Condition)  ~ "GFP",
      grepl("^YELL", Condition) ~ "YELL",
      TRUE ~ NA_character_
    ),
    Treatment = factor(Treatment, levels = c("CTL", "GFP", "YELL")),
    Week = factor(Week, levels = c(1, 2, 3, 5))
  )

# Global model 
mod_global <- lm(Log_1 ~ Treatment * Week, data = my_data)

# Diagnostics
shapiro.test(residuals(mod_global))
leveneTest(Log_1 ~ interaction(Treatment, Week), data = my_data)

# ANOVA 
anova(mod_global)

# Post hoc: pairwise Treatment contrasts within each Week (Bonferroni)
emm <- emmeans(mod_global, ~ Treatment | Week)
pairs(emm, adjust = "bonferroni")


